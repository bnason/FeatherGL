function clip(a,b,c){if(c>=b)return 0;if(c<=a)return 0;return c}function overflow(a,b,c){if(c>=b)return c-b;if(c<=a)return a-c;return c}var Feather=Feather||{};Feather.ORTHOGRAPHIC=0,Feather.PERSPECTIVE=1,Feather.ALIGN_CENTER=0,Feather.ALIGN_LEFT=1,Feather.ALIGN_RIGHT=2,Feather.MESH_TRIANGLES=0,Feather.MESH_TRIANGLE_STRIP=1,Feather.MESH_TRIANGLE_FAN=2,Feather.MESH_LINES=3,Feather.MESH_LINE_LOOP=4,Feather.MESH_POINTS=5,Feather.CAP_FLAT=0,Feather.CAP_SQUARE=1,Feather.CAP_ROUND=2,Feather.CAP_TRIANGLE=3,Math.TAU=Math.PI*2,Array.prototype.sum=function(){for(var a=0,b=this.length,c=0;a<b;c+=this[a++]);return c},Array.prototype.product=function(){for(var a=0,b=this.length,c=1;a<b;c=c*this[a++]);return c},Feather.Matrix=function(a){this.size=a,this.values=Array(a*a)},Feather.Matrix.prototype.copy=function(a){this.values=a.values.slice()},Feather.Matrix.copy=function(a){var b=new Feather.Matrix(a.size);b.copy(a);return b},Feather.Matrix.prototype.multiply=function(a){if(!(a instanceof Feather.Vector)&&!(a instanceof Feather.Matrix))throw"Feather.Matrix.multiply failed: Must be of type Feather.Matrix or Feather.Vector";if(this.size!=a.size)throw"Feather.Matrix.multiply failed: Not conformable";if(a instanceof Feather.Vector){var b=new Feather.Vector(this.size),c=a.toArray();for(var d=0;d<this.size;d++)for(var e=0;e<this.size;e++)b.values[d]+=this.values[d*3+e]*c[e];return b}if(a instanceof Feather.Matrix){var f=this.values[0],g=this.values[1],h=this.values[2],i=this.values[3],j=this.values[4],k=this.values[5],l=this.values[6],m=this.values[7],n=this.values[8],o=this.values[9],p=this.values[10],q=this.values[11],r=this.values[12],s=this.values[13],t=this.values[14],u=this.values[15],v=a.values[0],w=a.values[1],x=a.values[2],y=a.values[3],z=a.values[4],A=a.values[5],B=a.values[6],C=a.values[7],D=a.values[8],E=a.values[9],F=a.values[10],G=a.values[11],H=a.values[12],I=a.values[13],J=a.values[14],K=a.values[15];this.values[0]=f*v+j*w+n*x+r*y,this.values[1]=g*v+k*w+o*x+s*y,this.values[2]=h*v+l*w+p*x+t*y,this.values[3]=i*v+m*w+q*x+u*y,this.values[4]=f*z+j*A+n*B+r*C,this.values[5]=g*z+k*A+o*B+s*C,this.values[6]=h*z+l*A+p*B+t*C,this.values[7]=i*z+m*A+q*B+u*C,this.values[8]=f*D+j*E+n*F+r*G,this.values[9]=g*D+k*E+o*F+s*G,this.values[10]=h*D+l*E+p*F+t*G,this.values[11]=i*D+m*E+q*F+u*G,this.values[12]=f*H+j*I+n*J+r*K,this.values[13]=g*H+k*I+o*J+s*K,this.values[14]=h*H+l*I+p*J+t*K,this.values[15]=i*H+m*I+q*J+u*K;return this}},Feather.Matrix.multiply=function(a,b){var c=Feather.Matrix.copy(a);c.multiply(b);return c},Feather.Matrix.prototype.invert=function(){var a=this.values[0],b=this.values[1],c=this.values[2],d=this.values[3],e=this.values[4],f=this.values[5],g=this.values[6],h=this.values[7],i=this.values[8],j=this.values[9],k=this.values[10],l=this.values[11],m=this.values[12],n=this.values[13],o=this.values[14],p=this.values[15],q=a*f-b*e,r=a*g-c*e,s=a*h-d*e,t=b*g-c*f,u=b*h-d*f,v=c*h-d*g,w=i*n-j*m,x=i*o-k*m,y=i*p-l*m,z=j*o-k*n,A=j*p-l*n,B=k*p-l*o,C=1/(q*B-r*A+s*z+t*y-u*x+v*w);this.values[0]=(f*B-g*A+h*z)*C,this.values[1]=(-b*B+c*A-d*z)*C,this.values[2]=(n*v-o*u+p*t)*C,this.values[3]=(-j*v+k*u-l*t)*C,this.values[4]=(-e*B+g*y-h*x)*C,this.values[5]=(a*B-c*y+d*x)*C,this.values[6]=(-m*v+o*s-p*r)*C,this.values[7]=(i*v-k*s+l*r)*C,this.values[8]=(e*A-f*y+h*w)*C,this.values[9]=(-a*A+b*y-d*w)*C,this.values[10]=(m*u-n*s+p*q)*C,this.values[11]=(-i*u+j*s-l*q)*C,this.values[12]=(-e*z+f*x-g*w)*C,this.values[13]=(a*z-b*x+c*w)*C,this.values[14]=(-m*t+n*r-o*q)*C,this.values[15]=(i*t-j*r+k*q)*C},Feather.Matrix.prototype.transpose=function(){var a=this.values[1],b=this.values[2],c=this.values[5];this.values[1]=this.values[3],this.values[2]=this.values[6],this.values[3]=a,this.values[5]=this.values[7],this.values[6]=b,this.values[7]=c},Feather.Matrix.prototype.rotate=function(a,b,c,d){var e=Math.sqrt(b*b+c*c+d*d);if(!e)return null;e!=1&&(e=1/e,b*=e,c*=e,d*=e);var f=Math.sin(a),g=Math.cos(a),h=1-g,i=this.values[0],j=this.values[1],k=this.values[2],l=this.values[3],m=this.values[4],n=this.values[5],o=this.values[6],p=this.values[7],q=this.values[8],r=this.values[9],s=this.values[10],t=this.values[11],u=b*b*h+g,v=c*b*h+d*f,w=d*b*h-c*f,x=b*c*h-d*f,y=c*c*h+g,z=d*c*h+b*f,A=b*d*h+c*f,B=c*d*h-b*f,C=d*d*h+g;this.values[0]=i*u+m*v+q*w,this.values[1]=j*u+n*v+r*w,this.values[2]=k*u+o*v+s*w,this.values[3]=l*u+p*v+t*w,this.values[4]=i*x+m*y+q*z,this.values[5]=j*x+n*y+r*z,this.values[6]=k*x+o*y+s*z,this.values[7]=l*x+p*y+t*z,this.values[8]=i*A+m*B+q*C,this.values[9]=j*A+n*B+r*C,this.values[10]=k*A+o*B+s*C,this.values[11]=l*A+p*B+t*C},Feather.Matrix.prototype.rotateX=function(a){var b=Math.sin(a),c=Math.cos(a),d=this.values[4],e=this.values[5],f=this.values[6],g=this.values[7],h=this.values[8],i=this.values[9],j=this.values[10],k=this.values[11];this.values[4]=d*c+h*b,this.values[5]=e*c+i*b,this.values[6]=f*c+j*b,this.values[7]=g*c+k*b,this.values[8]=d*-b+h*c,this.values[9]=e*-b+i*c,this.values[10]=f*-b+j*c,this.values[11]=g*-b+k*c},Feather.Matrix.prototype.rotateY=function(a){var b=Math.sin(a),c=Math.cos(a),d=this.values[0],e=this.values[1],f=this.values[2],g=this.values[3],h=this.values[8],i=this.values[9],j=this.values[10],k=this.values[11];this.values[0]=d*c+h*-b,this.values[1]=e*c+i*-b,this.values[2]=f*c+j*-b,this.values[3]=g*c+k*-b,this.values[8]=d*b+h*c,this.values[9]=e*b+i*c,this.values[10]=f*b+j*c,this.values[11]=g*b+k*c},Feather.Matrix.prototype.rotateZ=function(a){var b=Math.sin(a),c=Math.cos(a),d=this.values[0],e=this.values[1],f=this.values[2],g=this.values[3],h=this.values[4],i=this.values[5],j=this.values[6],k=this.values[7];this.values[0]=d*c+h*b,this.values[1]=e*c+i*b,this.values[2]=f*c+j*b,this.values[3]=g*c+k*b,this.values[4]=d*-b+h*c,this.values[5]=e*-b+i*c,this.values[6]=f*-b+j*c,this.values[7]=g*-b+k*c},Feather.Matrix.prototype.translate=function(a,b,c){this.values[12]=this.values[0]*a+this.values[4]*b+this.values[8]*c+this.values[12],this.values[13]=this.values[1]*a+this.values[5]*b+this.values[9]*c+this.values[13],this.values[14]=this.values[2]*a+this.values[6]*b+this.values[10]*c+this.values[14],this.values[15]=this.values[3]*a+this.values[7]*b+this.values[11]*c+this.values[15]},Feather.Matrix.prototype.translateX=function(a){this.translate(a,0,0)},Feather.Matrix.prototype.translateY=function(a){this.translate(0,a,0)},Feather.Matrix.prototype.translateZ=function(a){this.translate(0,0,a)},Feather.Matrix.prototype.setIdentity=function(){for(i=0;i<this.size*this.size;i++)i%(this.size+1)==0?this.values[i]=1:this.values[i]=0},Feather.Matrix.prototype.setPerspective=function(a,b,c,d){var e,f,g,h;e=c*Math.tan(a*Math.PI/360),f=-e,g=f*b,h=e*b,this.makeFrustum(g,h,f,e,c,d)},Feather.Matrix.prototype.setFrustum=function(a,b,c,d,e,f){var g,h,i,j,k,l,m;h=2*e/(b-a),i=2*e/(d-c),j=(b+a)/(b-a),k=(d+c)/(d-c),l=-(f+e)/(f-e),m=-2*f*e/(f-e),this.values=[h,0,0,0,0,i,0,0,j,k,l,-1,0,0,m,0]},Feather.Matrix.prototype.setOrtho=function(a,b,c,d,e,f){var g,h,i,j,k,l;j=b-a,k=c-d,l=f-e,g=-(a+b)/j,h=-(c+d)/k,i=-(f+e)/l,this.values=[2/j,0,0,0,0,2/k,0,0,0,0,-2/l,0,g,h,i,1]},Feather.Matrix.prototype.setRotation=function(a,b){var c=Math.cos(b),d=Math.sin(b),e=1-c,f=a.toArray()[0],g=a.toArray()[1],h=a.toArray()[2];this.values=[c+f*f*e,f*g*e-h*d,f*h*e+g*d,g*f*e+h*d,c+g*g*e,g*h*e-f*d,h*f*e-g*d,h*g*e+f*d,c+h*h*e]},Feather.Matrix.prototype.setLookAt=function(a,b,c){var d=Feather.Vector.normalize(c),e=Feather.Vector.subtract(a,b);e.normalize();var f=Feather.Vector.cross(d,e);this.values[0]=f.getX(),this.values[4]=f.getY(),this.values[8]=f.getZ(),this.values[12]=0,this.values[1]=d.getX(),this.values[5]=d.getY(),this.values[9]=d.getZ(),this.values[13]=0,this.values[2]=e.getX(),this.values[6]=e.getY(),this.values[10]=e.getZ(),this.values[14]=0,this.values[3]=0,this.values[7]=0,this.values[11]=0,this.values[15]=1},Feather.Matrix.makeRotation=function(a,b){var c=new Feather.Matrix(3);c.setRotation(a,b);return c},Feather.Color=function(){this.r=1,this.g=1,this.b=1,this.a=1;return this},Feather.Color.prototype.toArray=function(){return[this.r,this.g,this.b,this.a]},Feather.Color.prototype.getRGB=function(){return[this.r,this.g,this.b]},Feather.Color.prototype.getRGBA=function(){return[this.r,this.g,this.b,this.a]},Feather.Color.prototype.setRGB=function(a,b,c){this.r=a,this.g=b,this.b=c,this.updateHex();return this},Feather.Color.prototype.setRGBA=function(a,b,c,d){this.r=a,this.g=b,this.b=c,this.a=d,this.updateHex();return this},Feather.Color.prototype.setHex=function(a){this.hex=~~a&16777215,this.updateRGB()},Feather.Color.prototype.setHSV=function(a,b,c){var d,e,f,g,h,i,j,k;if(c==0)d=e=f=0;else{g=Math.floor(a*6),h=a*6-g,i=c*(1-b),j=c*(1-b*h),k=c*(1-b*(1-h));switch(g){case 1:d=j,e=c,f=i;break;case 2:d=i,e=c,f=k;break;case 3:d=i,e=j,f=c;break;case 4:d=k,e=i,f=c;break;case 5:d=c,e=i,f=j;break;case 6:case 0:d=c,e=k,f=i}}this.r=d,this.g=e,this.b=f,this.updateHex()},Feather.Color.prototype.updateRGB=function(){this.r=(this.hex>>16&255)/255,this.g=(this.hex>>8&255)/255,this.b=(this.hex&255)/255},Feather.Color.prototype.updateHex=function(){this.hex=~~(this.r*255)<<16^~~(this.g*255)<<8^~~(this.b*255)},Feather.Mesh=function(a,b,c,d,e){this.type=e||Feather.MESH_TRIANGLES,this.texture=null,this.vertices=a||[],this.normals=c||[],this.colors=d||[],this.vertexIndexArray=b||[],this.vertexArray=[],this.modelview=new Feather.Matrix(4),this.modelview.setIdentity(),this.transformer=function(){},this.lighting=!0,this.changed=!0,this.lastUpdated=(new Date).getTime()},Feather.Mesh.prototype.update=function(){this.changed&&(this.updateVertexArray(),this.changed=!1,this.transformer(),this.lastUpdated=(new Date).getTime())},Feather.Mesh.prototype.render=function(a,b){this.update(a),a.updateBuffers(this,this.vertexArray,this.vertexIndexArray);var c=a.context,d=Feather.Matrix.multiply(b,this.modelview),e=new Feather.Matrix(4);e.copy(d),e.invert(),e.transpose(),c.uniformMatrix4fv(a.MatrixLocations.ModelView,!1,new Float32Array(d.values)),c.uniformMatrix4fv(a.MatrixLocations.Normal,!1,new Float32Array(e.values)),c.uniform1i(a.UniformLocations.UseLighting,this.lighting),c.bindBuffer(c.ARRAY_BUFFER,a.getVertexBuffer(this)),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a.getIndexBuffer(this)),c.vertexAttribPointer(a.AttributeLocations.Vertex,4,c.FLOAT,!1,48,0),c.vertexAttribPointer(a.AttributeLocations.Normal,4,c.FLOAT,!1,48,16),c.vertexAttribPointer(a.AttributeLocations.Color,4,c.FLOAT,!1,48,32);switch(this.type){case Feather.MESH_TRIANGLES:var f=c.TRIANGLES;break;case Feather.MESH_TRIANGLE_STRIP:var f=c.TRIANGLE_STRIP;break;case Feather.MESH_TRIANGLE_FAN:var f=c.TRIANGLE_FAN;break;case Feather.MESH_LINES:var f=c.LINES;break;case Feather.MESH_LINE_LOOP:var f=c.LINE_LOOP;break;case Feather.MESH_POINTS:var f=c.POINTS}c.drawElements(f,this.vertexIndexArray.length,c.UNSIGNED_SHORT,0)},Feather.Mesh.prototype.setType=function(a){this.type=a,this.webgl!=null&&this.updateBuffers(this.webgl.context),this.changed=!0},Feather.Mesh.prototype.setTransformer=function(a){this.transformer=a,this.changed=!0},Feather.Mesh.prototype.setTexture=function(a){this.texture=a,this.webgl!=null&&this.updateBuffers(this.webgl.context),this.changed=!0},Feather.Mesh.prototype.addVertex=function(a,b,c){this.vertices.push(a||(new Feather.Point).setXYZ(0,0,0)),this.normals.push(b||(new Feather.Vector).setXYZ(0,0,1)),this.colors.push(c||(new Feather.Color).setRGBA(0,0,0,1))},Feather.Mesh.prototype.addIndex=function(a){this.vertexIndexArray.push(a)},Feather.Mesh.prototype.updateVertexArray=function(a){this.vertexArray=[];for(var b=0;b<this.vertices.length;b++){var a=this.vertices[b];for(var c=0;c<3;c++)c<a.length?this.vertexArray.push(a[c]):this.vertexArray.push(0);this.vertexArray.push(1);var d=this.normals[b];for(var c=0;c<3;c++)c<d.length?this.vertexArray.push(d[c]):this.vertexArray.push(0);this.vertexArray.push(0);var e=this.colors[b];for(var c=0;c<e.length;c++)this.vertexArray.push(e[c])}},Feather.Mesh.prototype.getVertexArray=function(){return this.vertexArray},Feather.Mesh.prototype.rotateX=function(a){this.modelview.rotateX(a),this.changed=!0},Feather.Mesh.prototype.rotateY=function(a){this.modelview.rotateY(a),this.changed=!0},Feather.Mesh.prototype.rotateZ=function(a){this.modelview.rotateZ(a),this.changed=!0},Feather.Mesh.prototype.rotate=function(a,b){this.modelview.rotateX(a*b[0]),this.modelview.rotateY(a*b[1]),this.modelview.rotateZ(a*b[2]),this.changed=!0},Feather.Mesh.prototype.translateX=function(a){this.modelview.translateX(a),this.changed=!0},Feather.Mesh.prototype.translateY=function(a){this.modelview.translateY(a),this.changed=!0},Feather.Mesh.prototype.translateZ=function(a){this.modelview.translateZ(a),this.changed=!0},Feather.Mesh.prototype.translate=function(a,b,c){this.modelview.translateX(a),this.modelview.translateY(b),this.modelview.translateZ(c),this.changed=!0},Feather.Point=function(){var a="Point";this.variableName="";if(arguments.length==1){this.size=arguments[0],this.values=Array(this.size);for(var b=0;b<this.size;b++)this.values[b]=0}else{this.size=arguments.length,this.values=Array(this.size);for(var b=0;b<this.size;b++)this.values[b]=arguments[b]}},Feather.Point.prototype.toArray=function(){return this.values},Feather.Point.prototype.toSource=function(){var a="";this.variableName!=""&&(a=this.variableName+" = "),a+="Point("+this.values.join(", ")+");";return a},Feather.Point.prototype.toArgument=function(){if(this.variableName!="")return this.variableName;return"Point("+this.values.join(", ")+")"},Feather.Point.prototype.getX=function(){return this.values[0]},Feather.Point.prototype.getY=function(){return this.values[1]},Feather.Point.prototype.getZ=function(){return this.values[2]},Feather.Point.prototype.getVariableName=function(){return this.variableName},Feather.Point.prototype.setX=function(a){this.values[0]=a},Feather.Point.prototype.setY=function(a){this.values[1]=a},Feather.Point.prototype.setZ=function(a){this.values[2]=a},Feather.Point.prototype.setXY=function(a,b){this.values[0]=a,this.values[1]=b},Feather.Point.prototype.setXYZ=function(a,b,c){this.values[0]=a,this.values[1]=b,this.values[2]=c},Feather.Point.prototype.copy=function(a){if(this.size!=a.size)throw"Feather.Point.copy failed: Sizes must match "+this.size+" != "+a.size;this.values=a.toArray().slice()},Feather.Point.prototype.add=function(a){if(!(a instanceof Feather.Vector))throw"Feather.Point.add failed: Must be vector";if(this.size!=a.size)throw"Feather.Point.add failed: Sizes must match";var b=a.toArray();for(var c=0;c<this.size;c++)this.values[c]+=b[c]},Feather.Point.prototype.subtract=function(a){if(!(a instanceof Feather.Point))throw"Feather.Point.subtract failed: Must be point";if(this.size!=a.size)throw"Feather.Point.subtract failed: Sizes must match";var b=new Feather.Vector(this.size);b.copy(this);for(var c=0;c<b.size;c++)b.values[c]-=a.values[c];return b},Feather.Point.prototype.translate=function(a){if(a.size!=this.size)throw"Feather.Point.translate failed: Dimensions must match";var b=a.toArray();for(var c=0;c<this.size;c++)this.values[c]+=b[c]},Feather.Point.prototype.copy=function(a){if(this.size!=a.size)throw"Feather.Point.copy: Dimensions must match";this.values=a.toArray().slice()},Feather.Point.add=function(a,b){var c=new Feather.Point(a.size);c.copy(a),c.add(b);return c},Feather.Point.subtract=function(a,b){var c=new Feather.Vector(a.size);c.copy(a),c.subtract(b);return c},Feather.Point.translate=function(a,b){var c=new Feather.Point(a.size);c.copy(a),c.translate(b);return c},Feather.Point.copy=function(a){var b=new Feather.Point(a.size);b.copy(a);return b},Feather.Vector=function(){this.values=[0,0,0],this.X=0,this.Y=0,this.Z=0},Feather.Vector.prototype.getX=function(){return this.X},Feather.Vector.prototype.getY=function(){return this.Y},Feather.Vector.prototype.getZ=function(){return this.Z},Feather.Vector.prototype.setX=function(a){this.X=a;return this},Feather.Vector.prototype.setY=function(a){this.Y=a;return this},Feather.Vector.prototype.setZ=function(a){this.Z=a;return this},Feather.Vector.prototype.setXY=function(a,b){this.X=a,this.Y=b;return this},Feather.Vector.prototype.setXYZ=function(a,b,c){this.X=a,this.Y=b,this.Z=c;return this},Feather.Vector.prototype.toArray=function(){return[this.X,this.Y,this.Z]},Feather.Vector.prototype.toPoint=function(){var a=(new Feather.Point).setXYZ(this.X,this.Y,this.Z);return a},Feather.Vector.prototype.pointAt=function(a){this.values=a.values;return this},Feather.Vector.prototype.normalize=function(){var a=this.X*this.X+this.Y*this.Y+this.Z*this.Z,b=Math.sqrt(a);if(b==1)return this;this.X/=b,this.Y/=b,this.Z/=b;return this},Feather.Vector.prototype.add=function(a){if(this.size!=a.size)throw"Sizes must be the same for vector addition";if(typeof a!="Vector")throw"Can only add Vector to Vector instance";for(var b=0;b<this.size;b++)this.values[b]+=a.values[b]},Feather.Vector.prototype.subtract=function(a){if(this.size!=a.size)throw"Vector sizes must be the same for vector addition";var b=a.toArray();for(var c=0;c<this.size;c++)this.values[c]-=b[c]},Feather.Vector.prototype.dot=function(a){if(!(a instanceof Feather.Vector))throw"Feather.Vector.prototype.cross failed: Must be vector";if(this.size!=a.size)throw"Feather.Vector.dot: Dimensions must be equal.";var b=0;for(var c=0;c<this.size;c++)b+=this.values[c]*a.values[c];return b},Feather.Vector.prototype.cross=function(a){if(!(a instanceof Feather.Vector))throw"Feather.Vector.prototype.cross failed: Must be vector";if(this.size!=3||this.size!=a.size)throw"Vector sizes must be the same for vector addition";var b=this.X,c=this.Y,d=this.Z,e=a.X,f=a.Y,g=a.Z;this.X=c*g-d*f,this.Y=d*e-b*g,this.Z=b*f-c*e},Feather.Vector.prototype.scale=function(a){for(var b=0;b<this.size;b++)this.values[b]*=a},Feather.Vector.prototype.invert=function(){for(var a=0;a<this.size;a++)this.values[a]=-this.values[a]},Feather.Vector.prototype.length=function(){var a=0;for(var b=0;b<this.size;b++)a+=this.values[b]*this.values[b];return Math.sqrt(a)},Feather.Vector.prototype.copy=function(a){if(this.size!=a.size)throw"Vector size must match";this.values=a.toArray().slice()},Feather.Vector.normalize=function(a){var b=Feather.Vector.copy(a);b.normalize();return b},Feather.Vector.add=function(a,b){var c=Feather.Vector.copy(a);c.add(b);return c},Feather.Vector.subtract=function(a,b){var c=Feather.Vector.copy(a);c.subtract(b);return c},Feather.Vector.dot=function(a,b){return a.dot(b)},Feather.Vector.cross=function(a,b){var c=Feather.Vector.copy(a);c.cross(b);return c},Feather.Vector.scale=function(a,b){var c=Feather.Vector.copy(a);c.scale(b);return c},Feather.Vector.invert=function(a){var b=Feather.Vector.copy(a);b.invert();return b},Feather.Vector.length=function(a){return a.length()},Feather.Vector.copy=function(a){var b=new Feather.Vector(a.size);b.copy(a);return b},Feather.Framebuffer=function(a,b,c,d,e){this.webgl=a,this.scene=b||new Feather.Scene,this.camera=c||new Feather.Camera,this.width=d,this.height=e},Feather.WebGL=function(a){this.canvas=a,this.meshes=[],this.vertexBuffers=[],this.indexBuffers=[],this.meshBuffers=[];try{this.context=this.canvas.getContext("experimental-webgl",{antialias:!0}),this.context==null&&(this.context=this.canvas.getContext("webgl",{antialias:!0}))}catch(b){console.log(b);return}var c=this.context;c.clearColor(0,0,0,0),c.clearDepth(1),c.enable(c.DEPTH_TEST),c.depthFunc(c.LEQUAL),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),c.enable(c.LIGHTING),c.enable(34370),this.ShaderProgram=c.createProgram();var d=this.getShader(c.VERTEX_SHADER,this.shaders.vertex.join("\n"));c.attachShader(this.ShaderProgram,d);var e=this.getShader(c.FRAGMENT_SHADER,this.shaders.fragment.join("\n"));c.attachShader(this.ShaderProgram,e),c.linkProgram(this.ShaderProgram),c.getProgramParameter(this.ShaderProgram,c.LINK_STATUS)||console.log("Unable to intialize the shader program."),c.useProgram(this.ShaderProgram),this.MatrixLocations=[],this.MatrixLocations.Projection=c.getUniformLocation(this.ShaderProgram,"uProjectionMatrix"),this.MatrixLocations.ModelView=c.getUniformLocation(this.ShaderProgram,"uModelViewMatrix"),this.MatrixLocations.Normal=c.getUniformLocation(this.ShaderProgram,"uNormalMatrix"),this.AttributeLocations=[],this.AttributeLocations.Vertex=c.getAttribLocation(this.ShaderProgram,"aVertex"),this.AttributeLocations.Normal=c.getAttribLocation(this.ShaderProgram,"aNormal"),this.AttributeLocations.Color=c.getAttribLocation(this.ShaderProgram,"aColor"),c.enableVertexAttribArray(this.AttributeLocations.Vertex),c.enableVertexAttribArray(this.AttributeLocations.Normal),c.enableVertexAttribArray(this.AttributeLocations.Color),this.UniformLocations=[],this.UniformLocations.AmbientLightColor=c.getUniformLocation(this.ShaderProgram,"uAmbientLightColor"),this.UniformLocations.LightingDirection=c.getUniformLocation(this.ShaderProgram,"uLightingDirection"),this.UniformLocations.DirectionalColor=c.getUniformLocation(this.ShaderProgram,"uDirectionalColor"),this.UniformLocations.UseLighting=c.getUniformLocation(this.ShaderProgram,"uUseLighting")},Feather.WebGL.prototype.updateBuffers=function(a,b,c){var d=this.meshes.indexOf(a);d==-1&&(this.meshes.push(a),d=this.meshes.indexOf(a),this.vertexBuffers[d]=this.context.createBuffer(),this.indexBuffers[d]=this.context.createBuffer()),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffers[d]),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(b),gl.STATIC_DRAW),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffers[d]),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(c),gl.STATIC_DRAW)},Feather.WebGL.prototype.getVertexBuffer=function(a){var b=this.meshes.indexOf(a);if(b!=-1)return this.vertexBuffers[b];return null},Feather.WebGL.prototype.getIndexBuffer=function(a){var b=this.meshes.indexOf(a);if(b!=-1)return this.indexBuffers[b];return null},Feather.WebGL.prototype.getShader=function(a,b){gl=this.context,shader=gl.createShader(a),gl.shaderSource(shader,b),gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){console.log("An error occurred compiling the shader: "+a+"\n"+gl.getShaderInfoLog(shader));return null}return shader},Feather.WebGL.prototype.shaders={vertex:["uniform mat4 uProjectionMatrix;","uniform mat4 uModelViewMatrix;","uniform mat4 uNormalMatrix;","uniform vec3 uAmbientLightColor;","uniform vec3 uLightingDirection;","uniform vec3 uDirectionalColor;","uniform bool uUseLighting;","","attribute vec4 aVertex;","attribute vec4 aNormal;","attribute vec4 aColor;","","varying vec4 vColor;","varying vec3 vLighting;","","void main(void)","{","gl_PointSize = 8.0;","","gl_Position = uProjectionMatrix * (uModelViewMatrix * aVertex);","vColor = aColor;","","if (uUseLighting) {","vec4 transformedNormal = uNormalMatrix * aNormal;","float directionalLight = max(dot(transformedNormal.xyz, uLightingDirection), 0.0);","vLighting = uAmbientLightColor + (uDirectionalColor * directionalLight);","} else {","vLighting = vec3(1.0, 1.0, 1.0);","}","}"],fragment:["#ifdef GL_ES","precision highp float;","#endif","","varying vec4 vColor;","varying vec3 vLighting;","","void main(void)","{","gl_FragColor = vec4(vColor.rbg * vLighting, vColor.a);","}"]},Feather.Camera=function(a,b,c,d){this.location=a||new Feather.Point(0,0,0),this.gaze=b||new Feather.Vector(0,0,-1),this.width=c,this.height=d,this.aspect=this.width/this.height,this.lookAtLocation=null,this.lookAtLock=!1,this.up=new Feather.Vector(0,1,0),this.fov=50,this.near=1e-4,this.far=2e3,this.zoom=-5,this.modelview=new Feather.Matrix(4),this.modelview.setIdentity(),this.projectionMatrix3D=new Feather.Matrix(4),this.projectionMatrix2D=new Feather.Matrix(4),this.projectionmode=Feather.ORTHOGRAPHIC,this.changed=!0},Feather.Camera.prototype.update=function(){if(this.changed){this.modelview.setIdentity(),this.lookAtLocation!=null&&this.modelview.setLookAt(this.location,this.lookAtLocation,this.up),this.modelview.translate(-this.location.getX(),-this.location.getY(),-this.location.getZ());if(this.projectionmode==Feather.ORTHOGRAPHIC){var a=this.height/this.width,b=this.zoom/this.zoomSensitivity;this.projectionMatrix3D.setOrtho(this.zoom+1,-(this.zoom+1),-(this.zoom+1)*a,(this.zoom+1)*a,-1e3,1e3)}else this.projectionmode==Feather.PERSPECTIVE&&this.projectionMatrix3D.setPerspective(this.fov,this.aspect,this.near,this.far);this.projectionMatrix2D.setOrtho(-this.width/2,this.width/2,this.height/2,-this.height/2,0,10),this.changed=!1}},Feather.Camera.prototype.getModelviewMatrix=function(a){this.update();return this.modelview},Feather.Camera.prototype.getProjectionMatrix=function(a){this.update();if(a==2)return this.projectionMatrix2D;if(a==3)return this.projectionMatrix3D},Feather.Camera.prototype.setProjectionMode=function(a){this.projectionmode=a,this.changed=!0},Feather.Camera.prototype.lookAt=function(a,b){this.lookAtLocation=a,this.lookAtLock=b,this.gaze=Feather.Vector.subtract(this.lookAtLocation,this.location),this.changed=!0},Feather.Camera.prototype.setLocation=function(a){this.location=a,this.lookAtLock&&(this.gaze=Feather.Vector.subtract(this.lookAtLocation,this.location)),this.changed=!0},Feather.Camera.prototype.setZoom=function(a){a<=0&&(this.zoom=a),this.changed=!0},Feather.Light=function(a,b){this.location=a||new Feather.Point(0,0,0),this.color=b||new Feather.Color(0,0,0)},Feather.Scene=function(){this.meshes=[],this.lights=[],this.origin=new Feather.Point,this.ambientLightColor=(new Feather.Color).setRGB(.5,.5,.5),this.directionalLight=[],this.directionalLight.enabled=!0,this.directionalLight.color=(new Feather.Color).setRGBA(.25,.25,.25,1),this.directionalLight.direction=(new Feather.Vector).setXYZ(0,5,10).normalize(),this.changed=!0},Feather.Scene.prototype.addMesh=function(a){this.meshes.push(a),a.update(),this.changed=!0},Feather.Scene.prototype.render=function(a,b,c){var d=a.context;d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),d.uniform3fv(a.UniformLocations.AmbientLightColor,new Float32Array(this.ambientLightColor.getRGB())),d.uniform1i(a.UniformLocations.UseLighting,this.directionalLight.enabled),this.directionalLight.enabled&&(d.uniform3fv(a.UniformLocations.DirectionalColor,new Float32Array(this.directionalLight.color.getRGB())),d.uniform3fv(a.UniformLocations.LightingDirection,new Float32Array(this.directionalLight.direction.toArray())));for(var e=0;e<this.meshes.length;e++)d.uniformMatrix4fv(a.MatrixLocations.Projection,!1,new Float32Array(c.values)),this.meshes[e].render(a,b)},Feather.View=function(a,b,c){this.webgl=a,this.scene=b||new Feather.Scene,this.camera=c||new Feather.Camera(null,null,this.webgl.canvas.width,this.webgl.canvas.height),this.pickerBuffer=new Feather.Framebuffer(this.webgl,this.camera.width,this.camera.height),this.changed=!0,$(window).resize(function(){this.camera.height=this.webgl.canvas.height,this.camera.width=this.webgl.canvas.width,this.camera.aspect=this.camera.width/this.camera.height})},Feather.View.prototype.update=function(){this.webgl.context.viewport(0,0,this.webgl.canvas.width,this.webgl.canvas.height);var a=this.camera.getModelviewMatrix(),b=new Feather.Matrix(4);b.setIdentity(),this.scene.render(this.webgl,a,this.camera.getProjectionMatrix(3))},Feather.View.prototype.pickObjectAt=function(a){var b=new Feather.Point(a.getX()*2/this.camera.width-1,1-a.getY()*2/this.camera.height,0),c=Feather.UnProject(b,this.camera.getModelviewMatrix(3),this.camera.getProjectionMatrix(3),[0,0,this.camera.width,this.camera.height])};